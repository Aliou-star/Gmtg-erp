<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>GUIMETRA — ERP Pro (Auth, Audit, Admin)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/4f6b1f1d8b.js" crossorigin="anonymous"></script>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Firebase compat SDKs (doivent être chargés AVANT l'initialisation ci-dessous) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{--primary:#0b63a5;--accent:#e63946;--muted:#6b7280}
    body{font-family:Inter,system-ui,Arial;background:#f7fafc;color:#0f172a;margin:0}
    .site-header{background:linear-gradient(90deg,var(--primary),#0a597a);color:#fff;padding:20px;border-bottom:6px solid rgba(0,0,0,0.04)}
    .brand{font-weight:800}
    .nav-pills .nav-link{border-radius:8px}
    .card-ghost{background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(15,23,42,0.04);border-radius:12px}
    .soft-shadow{box-shadow:0 8px 20px rgba(15,23,42,0.06)}
    .fade-in { animation: fadeIn 360ms ease both; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(6px)} to {opacity:1; transform:none} }
    .centered-card{max-width:420px;margin:60px auto}
    .btn-accent{background:var(--accent);border-color:var(--accent);color:#fff}
    .small-muted{color:var(--muted)}
    pre.small{white-space:pre-wrap;font-size:12px}
    /* responsive */
    @media(max-width:768px){ .nav-pills { overflow:auto; white-space:nowrap; } }
  </style>
</head>
<body>
  <div class="site-header d-flex justify-content-between align-items-center">
    <div>
      <div class="brand fs-4">GUIMETRA <small style="color:var(--accent)">CONSTRUCTION</small></div>
      <div class="small">ERP • Devis • Stocks — Accès sécurisé</div>
    </div>
    <div id="userBox" class="text-end small"></div>
  </div>

  <main class="container py-4">
    <!-- AUTH SCREEN -->
    <div id="authScreen" class="fade-in">
      <div class="card centered-card p-4 soft-shadow">
        <h4 class="mb-3">Connexion</h4>
        <div id="authAlert" class="alert alert-danger d-none"></div>
        <input id="authEmail" class="form-control mb-2" placeholder="Email" />
        <input id="authPassword" type="password" class="form-control mb-2" placeholder="Mot de passe" />
        <div class="d-grid gap-2">
          <button class="btn btn-primary" onclick="signIn()">Se connecter</button>
          <button class="btn btn-outline-secondary" onclick="showRegister()">Créer un compte</button>
          <button class="btn btn-outline-dark" onclick="signInWithGoogle()"><i class="fa fa-google me-2"></i>Se connecter avec Google</button>
          <button class="btn btn-link text-muted" onclick="showReset()">Mot de passe oublié ?</button>
        </div>
      </div>

      <div id="registerCard" class="card centered-card p-4 mt-3" style="display:none">
        <h5>Créer un compte</h5>
        <input id="regEmail" class="form-control mb-2" placeholder="Email" />
        <input id="regPassword" type="password" class="form-control mb-2" placeholder="Mot de passe (6+)" />
        <div class="d-grid gap-2">
          <button class="btn btn-accent" onclick="signUp()">S'inscrire</button>
          <button class="btn btn-outline-secondary" onclick="hideRegister()">Annuler</button>
        </div>
      </div>

      <div id="resetCard" class="card centered-card p-4 mt-3" style="display:none">
        <h5>Réinitialiser mot de passe</h5>
        <input id="resetEmail" class="form-control mb-2" placeholder="Ton email" />
        <div class="d-grid gap-2">
          <button class="btn btn-primary" onclick="sendPasswordReset()">Envoyer lien</button>
          <button class="btn btn-outline-secondary" onclick="hideReset()">Annuler</button>
        </div>
      </div>
    </div>

    <!-- APP (visible when logged in) -->
    <div id="app" style="display:none">
      <ul class="nav nav-pills mb-3" id="mainTabs">
        <li class="nav-item"><a class="nav-link active" data-target="dashboard">Tableau</a></li>
        <li class="nav-item"><a class="nav-link" data-target="produits">Produits</a></li>
        <li class="nav-item"><a class="nav-link" data-target="clients">Clients</a></li>
        <li class="nav-item"><a class="nav-link" data-target="devis">Devis</a></li>
        <li class="nav-item"><a class="nav-link" data-target="convertisseur">Convertisseur</a></li>
        <li class="nav-item"><a class="nav-link" data-target="reports">Rapports</a></li>
        <li class="nav-item ms-auto"><button id="adminBtn" class="btn btn-sm btn-outline-light me-2" style="display:none" onclick="openAdminPanel()">Admin</button><button class="btn btn-sm btn-outline-light" onclick="signOut()">Déconnexion</button></li>
      </ul>

      <div id="content">
        <!-- Dashboard -->
        <div id="dashboard" class="card card-ghost p-3 soft-shadow fade-in">
          <div class="row">
            <div class="col-md-8">
              <h5>Bienvenue</h5>
              <p class="small-muted">Toutes les actions (create/update/delete/convert) sont archivées dans <b>audit_logs</b>.</p>
              <div class="row gy-3">
                <div class="col-6"><div class="p-3 bg-white rounded"><div class="small-muted">Produits</div><div id="stat_produits" class="fs-4 fw-bold">0</div></div></div>
                <div class="col-6"><div class="p-3 bg-white rounded"><div class="small-muted">Clients</div><div id="stat_clients" class="fs-4 fw-bold">0</div></div></div>
              </div>
            </div>
            <div class="col-md-4 d-flex align-items-center justify-content-center"><div class="text-center small-muted">Connecté en tant que <b id="userEmail"></b></div></div>
          </div>
        </div>

        <!-- Produits -->
        <div id="produits" class="card card-ghost p-3 soft-shadow mt-3" style="display:none">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Produits</h5>
            <div>
              <button class="btn btn-outline-secondary me-2" onclick="loadProducts()">Rafraîchir</button>
              <button class="btn btn-primary" onclick="openProductModal()">+ Ajouter</button>
            </div>
          </div>
          <div class="table-responsive"><table class="table table-hover"><thead><tr><th>Produit</th><th>Prix</th><th>Qte</th><th></th></tr></thead><tbody id="tblProducts"></tbody></table></div>
        </div>

        <!-- Clients -->
        <div id="clients" class="card card-ghost p-3 soft-shadow mt-3" style="display:none">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Clients</h5>
            <button class="btn btn-primary" onclick="openClientModal()">+ Ajouter client</button>
          </div>
          <div class="table-responsive"><table class="table"><thead><tr><th>Nom</th><th>Téléphone</th><th>Adresse</th><th></th></tr></thead><tbody id="tblClients"></tbody></table></div>
        </div>

        <!-- Devis -->
        <div id="devis" class="card card-ghost p-3 soft-shadow mt-3" style="display:none">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Devis</h5>
            <div>
              <button class="btn btn-outline-secondary me-2" onclick="addQuoteLine()">+ Ligne</button>
              <button class="btn btn-primary" onclick="saveQuote()">Enregistrer Devis</button>
              <button class="btn btn-success" onclick="previewPDF()"><i class="fa fa-file-pdf me-2"></i>Télécharger PDF</button>
            </div>
          </div>
          <div class="mb-2"><label class="small-muted">Client</label><select id="quote_client" class="form-select"></select></div>
          <div id="quote_lines" class="mb-2"></div>
          <div class="card p-2"><div class="d-flex justify-content-between"><div><b>Aperçu</b></div><div>Total : <span id="quote_total">0</span> GNF</div></div><div id="quote_preview_content" class="mt-2 small-muted"></div></div>
        </div>

        <!-- Convertisseur -->
        <div id="convertisseur" class="card card-ghost p-3 soft-shadow mt-3" style="display:none">
          <h5>Convertisseur</h5>
          <div class="row g-2 align-items-end">
            <div class="col-md-4"><label class="small-muted">Montant</label><input id="conv_amount" class="form-control"></div>
            <div class="col-md-3"><label class="small-muted">De</label><select id="conv_from" class="form-select"><option>GNF</option><option>USD</option><option>EUR</option><option>XOF</option></select></div>
            <div class="col-md-3"><label class="small-muted">Vers</label><select id="conv_to" class="form-select"><option>USD</option><option>EUR</option><option>XOF</option><option>GNF</option></select></div>
            <div class="col-md-2"><button class="btn btn-primary w-100" onclick="convertCurrency()">Convertir</button></div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6"><div class="card p-3"><div class="small-muted">Résultat</div><div id="conv_result" class="fs-5 mt-2">—</div></div></div>
            <div class="col-md-6"><label class="small-muted">Taux manuel</label><input id="manual_rate" class="form-control"></div>
          </div>
        </div>

        <!-- Reports -->
        <div id="reports" class="card card-ghost p-3 soft-shadow mt-3" style="display:none">
          <h5>Rapports & Historique</h5>
          <p class="small-muted">Filtrer et exporter l'historique (audit, conversions, devis).</p>

          <div class="mb-3 d-flex gap-2">
            <input type="date" id="r_from" class="form-control" />
            <input type="date" id="r_to" class="form-control" />
            <button class="btn btn-outline-secondary" onclick="loadAudit()">Charger audit</button>
            <button class="btn btn-accent" onclick="exportAuditCSV()">Exporter CSV</button>
          </div>

          <div style="max-height:400px; overflow:auto">
            <table class="table table-sm"><thead><tr><th>Date</th><th>Action</th><th>User</th><th>Details</th></tr></thead><tbody id="tblAudit"></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modals product & client -->
  <div class="modal fade" id="modalProduct" tabindex="-1"><div class="modal-dialog modal-md modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Produit</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <input id="m_p_id" type="hidden">
      <label class="small-muted">Nom</label><input id="m_p_nom" class="form-control mb-2">
      <label class="small-muted">Code</label><input id="m_p_code" class="form-control mb-2">
      <label class="small-muted">Type</label><input id="m_p_type" class="form-control mb-2">
      <label class="small-muted">Dimensions</label><input id="m_p_dim" class="form-control mb-2">
      <label class="small-muted">Prix vente (GNF)</label><input id="m_p_prix" class="form-control mb-2" type="number">
      <label class="small-muted">Quantité</label><input id="m_p_qte" class="form-control mb-2" type="number">
    </div>
    <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" onclick="saveProductModal()">Enregistrer</button></div>
  </div></div></div>

  <div class="modal fade" id="modalClient" tabindex="-1"><div class="modal-dialog modal-md modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Client</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <label class="small-muted">Nom</label><input id="m_c_nom" class="form-control mb-2">
      <label class="small-muted">Téléphone</label><input id="m_c_tel" class="form-control mb-2">
      <label class="small-muted">Adresse</label><input id="m_c_addr" class="form-control mb-2">
    </div>
    <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" onclick="saveClientModal()">Enregistrer</button></div>
  </div></div></div>

  <!-- Admin panel modal -->
  <div class="modal fade" id="modalAdmin" tabindex="-1"><div class="modal-dialog modal-md modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Admin: Gestion des rôles</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <p class="small-muted">Donner le rôle <b>admin</b> à un utilisateur (uid).</p>
      <label class="small-muted">UID utilisateur</label><input id="admin_uid" class="form-control mb-2" placeholder="ex: uid de l'utilisateur">
      <div class="d-grid gap-2">
        <button class="btn btn-accent" onclick="grantAdmin()">Attribuer rôle admin</button>
        <button class="btn btn-outline-danger" onclick="revokeAdmin()">Révoquer admin</button>
      </div>
      <hr/>
      <p class="small-muted">Tu peux obtenir ton UID après connexion (affiché dans la console en bas).</p>
    </div>
    <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button></div>
  </div></div></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- =========== FIREBASE CONFIG (TA CONFIG) =========== -->
  <script>
    // --- Remplace le bloc ci-dessous si tu veux une autre config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAC8FPE55zBg06Tjj-AE1DM6QohfAjmGHI",
      authDomain: "gestion-stock-pro-696af.firebaseapp.com",
      projectId: "gestion-stock-pro-696af",
      storageBucket: "gestion-stock-pro-696af.firebasestorage.app",
      messagingSenderId: "100191592139",
      appId: "1:100191592139:web:3e764a85f58e11b9cdc54e"
    };

    // Initialize Firebase (compat)
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>

  <!-- =========== APP SCRIPT (auth + CRUD + audit + reports + admin) =========== -->
  <script>
    // State
    let productsCache = [], clientsCache = [], quoteLines = [];
    let currentUserRole = null; // 'admin' or null

    // -------------- AUTH --------------
    async function signUp(){
      const email = document.getElementById('regEmail').value.trim();
      const pw = document.getElementById('regPassword').value;
      if(!email || !pw){ alert('Email et mot de passe requis'); return; }
      try{
        const userCred = await auth.createUserWithEmailAndPassword(email, pw);
        await auditLog('signup', null, { email });
        alert('Compte créé et connecté');
        hideRegister();
      }catch(e){ alert('Erreur inscription: ' + e.message); }
    }

    async function signIn(){
      const email = document.getElementById('authEmail').value.trim();
      const pw = document.getElementById('authPassword').value;
      try{
        const userCred = await auth.signInWithEmailAndPassword(email, pw);
        await auditLog('signin', null, { email });
      }catch(e){
        document.getElementById('authAlert').classList.remove('d-none');
        document.getElementById('authAlert').innerText = e.message;
      }
    }

    async function signInWithGoogle(){
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        const res = await auth.signInWithPopup(provider);
        await auditLog('signin_google', null, { email: res.user.email });
      }catch(e){ alert('Erreur Google Sign-In: '+e.message); }
    }

    async function signOut(){
      const u = auth.currentUser;
      if(u) await auditLog('signout', null, { email: u.email });
      await auth.signOut();
    }

    function showRegister(){ document.getElementById('registerCard').style.display='block'; document.getElementById('authScreen').scrollIntoView(); }
    function hideRegister(){ document.getElementById('registerCard').style.display='none'; }
    function showReset(){ document.getElementById('resetCard').style.display='block'; }
    function hideReset(){ document.getElementById('resetCard').style.display='none'; }

    async function sendPasswordReset(){
      const email = document.getElementById('resetEmail').value.trim();
      if(!email) { alert('Donne ton email'); return; }
      try{ await auth.sendPasswordResetEmail(email); alert('Lien envoyé'); hideReset(); }catch(e){ alert('Erreur: '+e.message); }
    }

    // -------------- AUDIT LOG --------------
    async function auditLog(action, docId=null, details={}){
      try{
        const u = auth.currentUser;
        await db.collection('audit_logs').add({
          uid: u ? u.uid : null,
          email: u ? u.email : null,
          action,
          docId: docId || null,
          details,
          ts: firebase.firestore.FieldValue.serverTimestamp()
        });
      }catch(e){ console.error('audit error', e); }
    }

    // -------------- ROLE CHECK --------------
    async function loadUserRole(uid){
      if(!uid) { currentUserRole = null; return; }
      try{
        const snap = await db.collection('roles').doc(uid).get();
        if(snap.exists){
          currentUserRole = snap.data().role || null;
        } else currentUserRole = null;
        // toggle admin UI
        document.getElementById('adminBtn').style.display = currentUserRole==='admin' ? 'inline-block' : 'none';
      }catch(e){ console.error('loadUserRole', e); }
    }

    // -------------- AUTH STATE --------------
    auth.onAuthStateChanged(async (user)=>{
      if(user){
        document.getElementById('authScreen').style.display='none';
        document.getElementById('app').style.display='block';
        document.getElementById('userEmail').innerText = user.email;
        document.getElementById('userBox').innerHTML = `<div>Connecté: ${user.email}<br/><small class="text-muted">UID: ${user.uid}</small></div>`;
        await auditLog('auth_state', null, { state: 'signed_in' });
        await loadUserRole(user.uid);
        // load data
        loadProducts(); loadClients();
        // default show dashboard
        showTab('dashboard');
        addQuoteLine();
      } else {
        document.getElementById('authScreen').style.display='block';
        document.getElementById('app').style.display='none';
        document.getElementById('userBox').innerHTML = '';
        currentUserRole = null;
      }
    });

    // -------------- PRODUCTS --------------
    function openProductModal(prod=null){
      if(prod){
        document.getElementById('m_p_id').value = prod.id;
        document.getElementById('m_p_nom').value = prod.nom||'';
        document.getElementById('m_p_code').value = prod.code||'';
        document.getElementById('m_p_type').value = prod.type||'';
        document.getElementById('m_p_dim').value = prod.dimensions||'';
        document.getElementById('m_p_prix').value = prod.prixVente||0;
        document.getElementById('m_p_qte').value = prod.quantite||0;
      } else {
        ['m_p_id','m_p_nom','m_p_code','m_p_type','m_p_dim','m_p_prix','m_p_qte'].forEach(id=>document.getElementById(id).value='');
      }
      new bootstrap.Modal(document.getElementById('modalProduct')).show();
    }

    async function saveProductModal(){
      if(!auth.currentUser){ alert('Connecte-toi'); return; }
      const id = document.getElementById('m_p_id').value || null;
      const payload = {
        nom: document.getElementById('m_p_nom').value.trim(),
        code: document.getElementById('m_p_code').value.trim(),
        type: document.getElementById('m_p_type').value.trim(),
        dimensions: document.getElementById('m_p_dim').value.trim(),
        prixVente: Number(document.getElementById('m_p_prix').value||0),
        quantite: Number(document.getElementById('m_p_qte').value||0),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      try{
        if(id){
          await db.collection('produits').doc(id).update(payload);
          await auditLog('update_product', id, payload);
        } else {
          payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const ref = await db.collection('produits').add(payload);
          await auditLog('create_product', ref.id, payload);
        }
        bootstrap.Modal.getInstance(document.getElementById('modalProduct')).hide();
      }catch(e){ console.error(e); alert('Erreur sauvegarde produit: '+e.message); }
    }

    async function deleteProduit(id){
      // only allow if admin role
      const u = auth.currentUser;
      if(!u) return alert('Connecte-toi');
      await loadUserRole(u.uid);
      if(currentUserRole !== 'admin') return alert('Action réservée à l\'admin');
      if(!confirm('Supprimer ce produit ?')) return;
      try{
        await db.collection('produits').doc(id).delete();
        await auditLog('delete_product', id, {});
      }catch(e){ console.error(e); alert('Erreur suppression'); }
    }

    db.collection('produits').orderBy('nom').onSnapshot(snap=>{
      productsCache = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderProducts();
      updateStats();
    });

    function renderProducts(){
      const tbody = document.getElementById('tblProducts');
      tbody.innerHTML = '';
      productsCache.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><div class="fw-bold">${escapeHtml(p.nom)}</div><small class="small-muted">${escapeHtml(p.type)} ${escapeHtml(p.dimensions||'')}</small></td>
                        <td>${(p.prixVente||0).toLocaleString()}</td>
                        <td>${p.quantite||0}</td>
                        <td class="text-end">
                          <button class="btn btn-sm btn-outline-primary me-1" onclick='openProductModal(${JSON.stringify(p).replace(/'/g,"\\'")})'><i class="fa fa-pen"></i></button>
                          <button class="btn btn-sm btn-outline-danger" onclick="deleteProduit('${p.id}')"><i class="fa fa-trash"></i></button>
                        </td>`;
        tbody.appendChild(tr);
      });
    }

    // -------------- CLIENTS --------------
    function openClientModal(c=null){
      if(c){ document.getElementById('m_c_nom').value=c.nom||''; document.getElementById('m_c_tel').value=c.tel||''; document.getElementById('m_c_addr').value=c.addr||''; }
      else { ['m_c_nom','m_c_tel','m_c_addr'].forEach(id=>document.getElementById(id).value=''); }
      new bootstrap.Modal(document.getElementById('modalClient')).show();
    }

    async function saveClientModal(){
      if(!auth.currentUser) { alert('Connecte-toi'); return; }
      const doc = { nom: document.getElementById('m_c_nom').value.trim(), tel: document.getElementById('m_c_tel').value.trim(), addr: document.getElementById('m_c_addr').value.trim(), createdAt: firebase.firestore.FieldValue.serverTimestamp() };
      if(!doc.nom){ alert('Nom requis'); return; }
      try{ const ref = await db.collection('clients').add(doc); await auditLog('create_client', ref.id, doc); bootstrap.Modal.getInstance(document.getElementById('modalClient')).hide(); }catch(e){ console.error(e); alert('Erreur ajout client'); }
    }

    async function deleteClient(id){ // admin only
      const u = auth.currentUser; if(!u) return alert('Connecte-toi'); await loadUserRole(u.uid); if(currentUserRole!=='admin') return alert('Action réservée à l\'admin'); if(!confirm('Supprimer client ?')) return; try{ await db.collection('clients').doc(id).delete(); await auditLog('delete_client', id, {}); }catch(e){ console.error(e); alert('Erreur suppression'); } }
    db.collection('clients').orderBy('nom').onSnapshot(snap=>{ clientsCache = snap.docs.map(d=>({id:d.id,...d.data()})); renderClients(); updateStats(); });

    function renderClients(){
      const tbody = document.getElementById('tblClients'); const sel=document.getElementById('quote_client');
      tbody.innerHTML=''; sel.innerHTML='<option value="">-- Aucun --</option>';
      clientsCache.forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(c.nom)}</td><td>${escapeHtml(c.tel||'')}</td><td>${escapeHtml(c.addr||'')}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="deleteClient('${c.id}')"><i class="fa fa-trash"></i></button></td>`; tbody.appendChild(tr); const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.nom + (c.tel ? ' • ' + c.tel : ''); sel.appendChild(opt); });
    }

    // -------------- DEVIS --------------
    function addQuoteLine(){ quoteLines.push({productId:'', qty:1, price:0}); renderQuoteLines(); }
    function removeQuoteLine(i){ quoteLines.splice(i,1); renderQuoteLines(); }
    function renderQuoteLines(){
      const container=document.getElementById('quote_lines'); container.innerHTML='';
      quoteLines.forEach((l,i)=>{ const wrapper=document.createElement('div'); wrapper.className='d-flex gap-2 mb-2'; wrapper.innerHTML=`<select class="form-select" id="ql_prod_${i}" style="flex:2"><option value="">-- produit --</option></select><input class="form-control" id="ql_qty_${i}" type="number" style="max-width:120px" value="${l.qty}"><input class="form-control" id="ql_price_${i}" style="max-width:150px" value="${l.price}"><button class="btn btn-outline-danger" onclick="removeQuoteLine(${i})"><i class="fa fa-trash"></i></button>`; container.appendChild(wrapper); const sel = wrapper.querySelector(`#ql_prod_${i}`); productsCache.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.text=p.nom; if(p.id===l.productId) opt.selected=true; sel.appendChild(opt); }); sel.onchange=(e)=>{ const pid=e.target.value; const p=productsCache.find(x=>x.id===pid); quoteLines[i].productId=pid; quoteLines[i].price=p? (p.prixVente||0):0; renderQuoteLines(); }; wrapper.querySelector(`#ql_qty_${i}`).oninput=(e)=>{ quoteLines[i].qty=Number(e.target.value||0); renderQuotePreview(); }; wrapper.querySelector(`#ql_price_${i}`).oninput=(e)=>{ quoteLines[i].price=Number(e.target.value||0); renderQuotePreview(); }; });
      renderQuotePreview();
    }

    function renderQuotePreview(){ let html=''; let total=0; quoteLines.forEach(l=>{ const p=productsCache.find(x=>x.id===l.productId)||{}; const name=p.nom||'—'; const lineTotal=(Number(l.price)||0)*(Number(l.qty)||0); total+=lineTotal; html+=`<div class="d-flex justify-content-between"><div><b>${escapeHtml(name)}</b><div class="small-muted">${escapeHtml(p.code||'')}</div></div><div>${(Number(l.qty)||0)} × ${(Number(l.price)||0).toLocaleString()} = ${lineTotal.toLocaleString()} GNF</div></div><hr>`; }); document.getElementById('quote_preview_content').innerHTML = html || '<div class="small-muted">Aucune ligne</div>'; document.getElementById('quote_total').innerText = total.toLocaleString(); }

    async function saveQuote(){ if(!auth.currentUser){ alert('Connecte-toi'); return; } const clientId=document.getElementById('quote_client').value||null; const data={ clientId, lines: JSON.parse(JSON.stringify(quoteLines)), total: Number((document.getElementById('quote_total').innerText||'0').replace(/,/g,'')), createdAt: firebase.firestore.FieldValue.serverTimestamp() }; try{ const ref=await db.collection('devis').add(data); await auditLog('create_quote', ref.id, data); alert('Devis enregistré'); }catch(e){ console.error(e); alert('Erreur enregistrement devis'); } }

    function previewPDF(){ const clientId=document.getElementById('quote_client').value; const client=clientsCache.find(c=>c.id===clientId); const el=document.createElement('div'); el.style.fontFamily='Arial'; el.style.padding='20px'; el.innerHTML=`<h3>Devis - ${escapeHtml(client?client.nom:'Client')}</h3>${document.getElementById('quote_preview_content').innerHTML}<h4>Total : ${document.getElementById('quote_total').innerText} GNF</h4>`; html2pdf().from(el).set({margin:10, filename:`devis-${Date.now()}.pdf`}).save(); }

    // -------------- CONVERTISSEUR --------------
    async function convertCurrency(){
      if(!auth.currentUser){ alert('Connecte-toi'); return; }
      const amount=Number(document.getElementById('conv_amount').value||0); const from=document.getElementById('conv_from').value; const to=document.getElementById('conv_to').value;
      if(!amount){ alert('Saisis un montant'); return; }
      let resultat=null; let mode='api';
      try{ const r=await fetch(`https://api.exchangerate.host/convert?from=${from}&to=${to}&amount=${amount}`); const d=await r.json(); if(d && d.result!=null) resultat=d.result; else throw 'no result'; }
      catch(e){ const manual=Number(document.getElementById('manual_rate').value||0); if(manual){ resultat = amount * manual; mode='manuel'; } else { document.getElementById('conv_result').innerText='Conversion impossible (API ou taux manuel)'; return; } }
      document.getElementById('conv_result').innerText = `${resultat.toLocaleString()} ${to}`;
      try{ const ref = await db.collection('conversions').add({ montant: amount, from, to, resultat, mode, user: auth.currentUser.uid, ts: firebase.firestore.FieldValue.serverTimestamp() }); await auditLog('conversion', ref.id, { amount, from, to, resultat, mode }); }catch(e){ console.error('save conversion', e); alert('Erreur sauvegarde conversion'); }
    }

    // -------------- REPORTS (audit) --------------
    async function loadAudit(){
      const from = document.getElementById('r_from').value;
      const to = document.getElementById('r_to').value;
      let q = db.collection('audit_logs').orderBy('ts','desc').limit(500);
      if(from){
        const f = new Date(from); q = q.where('ts','>=', firebase.firestore.Timestamp.fromDate(f));
      }
      if(to){
        const t = new Date(to); t.setDate(t.getDate()+1); q = q.where('ts','<=', firebase.firestore.Timestamp.fromDate(t));
      }
      const snap = await q.get();
      const rows = snap.docs.map(d=>({id:d.id, ...d.data()}));
      const tbody = document.getElementById('tblAudit'); tbody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const date = r.ts ? new Date(r.ts.seconds*1000).toLocaleString() : '';
        tr.innerHTML = `<td>${date}</td><td>${escapeHtml(r.action)}</td><td>${escapeHtml(r.email||r.uid||'')}</td><td><pre class="small">${escapeHtml(JSON.stringify(r.details||{}))}</pre></td>`;
        tbody.appendChild(tr);
      });
    }

    function exportAuditCSV(){
      // grab current table rows
      const rows = Array.from(document.querySelectorAll('#tblAudit tr')).map(tr=>{
        return Array.from(tr.cells).map(td => td.innerText.replace(/\n/g,' '));
      });
      if(rows.length===0) return alert('Aucun audit chargé');
      // CSV
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `audit-${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
    }

    // -------------- ADMIN PANEL (grant/revoke role) --------------
    function openAdminPanel(){ new bootstrap.Modal(document.getElementById('modalAdmin')).show(); }
    async function grantAdmin(){
      const uid = document.getElementById('admin_uid').value.trim();
      if(!uid) return alert('UID requis');
      try{
        await db.collection('roles').doc(uid).set({ role:'admin' });
        alert('Rôle admin attribué (roles/'+uid+')');
        await auditLog('grant_admin', uid, {});
      }catch(e){ console.error(e); alert('Erreur grant admin: '+e.message); }
    }
    async function revokeAdmin(){
      const uid = document.getElementById('admin_uid').value.trim();
      if(!uid) return alert('UID requis');
      try{
        await db.collection('roles').doc(uid).delete();
        alert('Rôle admin révoqué');
        await auditLog('revoke_admin', uid, {});
      }catch(e){ console.error(e); alert('Erreur revoke: '+e.message); }
    }

    // -------------- UTIL & STATS --------------
    function updateStats(){ document.getElementById('stat_produits').innerText = productsCache.length; document.getElementById('stat_clients').innerText = clientsCache.length; }
    function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // -------------- SNAPSHOTS --------------
    db.collection('produits').orderBy('nom').onSnapshot(snap=>{ productsCache = snap.docs.map(d=>({id:d.id,...d.data()})); renderProducts(); updateStats(); });
    db.collection('clients').orderBy('nom').onSnapshot(snap=>{ clientsCache = snap.docs.map(d=>({id:d.id,...d.data()})); renderClients(); updateStats(); });

    // -------------- RENDER HELPERS --------------
    function renderProducts(){ const tbody=document.getElementById('tblProducts'); tbody.innerHTML=''; productsCache.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><div class="fw-bold">${escapeHtml(p.nom)}</div><small class="small-muted">${escapeHtml(p.type)} ${escapeHtml(p.dimensions||'')}</small></td><td>${(p.prixVente||0).toLocaleString()}</td><td>${p.quantite||0}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary me-1" onclick='openProductModal(${JSON.stringify(p).replace(/'/g,"\\'")})'><i class="fa fa-pen"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteProduit('${p.id}')"><i class="fa fa-trash"></i></button></td>`; tbody.appendChild(tr); }); }
    function renderClients(){ const tbody=document.getElementById('tblClients'); const sel=document.getElementById('quote_client'); tbody.innerHTML=''; sel.innerHTML='<option value="">-- Aucun --</option>'; clientsCache.forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(c.nom)}</td><td>${escapeHtml(c.tel||'')}</td><td>${escapeHtml(c.addr||'')}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="deleteClient('${c.id}')"><i class="fa fa-trash"></i></button></td>`; tbody.appendChild(tr); const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.nom + (c.tel ? ' • ' + c.tel : ''); sel.appendChild(opt); }); }

    // -------------- NAV --------------
    function showTab(id){
      document.querySelectorAll('#mainTabs .nav-link').forEach(n=>n.classList.remove('active'));
      document.querySelectorAll('#mainTabs .nav-link').forEach(n=>{ if(n.dataset.target===id) n.classList.add('active'); });
      document.querySelectorAll('#content > div').forEach(d=>d.style.display='none');
      document.getElementById(id).style.display='block';
    }
    document.querySelectorAll('#mainTabs .nav-link').forEach(a=>a.addEventListener('click',()=>{ showTab(a.dataset.target); }));

    // -------------- INIT --------------
    document.addEventListener('DOMContentLoaded', ()=>{ addQuoteLine(); });
  </script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>GUIMETRA — ERP Pro (Local) — Dashboard amélioré</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://kit.fontawesome.com/4f6b1f1d8b.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{--primary:#0b63a5;--accent:#e63946;--bg:#f7fafc;--muted:#6b7280;--glass:rgba(255,255,255,0.9)}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#f7fafc,#eef6fb);color:#0f172a;margin:0}
    header{background:linear-gradient(90deg,var(--primary),#0a597a);color:#fff;padding:18px 20px;display:flex;align-items:center;gap:12px;justify-content:space-between;box-shadow:0 8px 30px rgba(11,99,165,0.12)}
    .brand{font-weight:800;font-size:20px;letter-spacing:0.6px}
    .brand small{color:var(--accent);font-weight:800;margin-left:8px}
    nav{padding:14px;background:var(--glass);display:flex;gap:10px;align-items:center;flex-wrap:wrap;backdrop-filter: blur(6px);border-bottom:1px solid rgba(11,99,165,0.06)}
    .nav-btn{background:transparent;border:1px solid transparent;padding:8px 12px;border-radius:8px;cursor:pointer;color:var(--primary);font-weight:600}
    .nav-btn.active{background:linear-gradient(90deg,#e7f1fb, #dff0fb);border-color:rgba(11,99,165,0.12)}
    main{padding:18px;max-width:1200px;margin:22px auto}
    .card-ghost{background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(12,20,30,0.06);transition:transform .18s ease,box-shadow .18s ease}
    .card-ghost:hover{transform:translateY(-4px);box-shadow:0 18px 36px rgba(12,20,30,0.08)}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .fade-in{animation:fadeIn .36s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    .metric{padding:18px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 6px 18px rgba(10,20,30,0.04);display:flex;justify-content:space-between;align-items:center;transition:transform .12s}
    .metric:hover{transform:translateY(-4px)}
    .muted{color:var(--muted)}
    table.data{width:100%;border-collapse:collapse}
    table.data th, table.data td{padding:10px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
    .btn-accent{background:var(--accent);color:#fff;border:none}
    .small-muted{font-size:13px;color:var(--muted)}
    /* toast */
    #toast{position:fixed;right:18px;bottom:18px;z-index:9999;min-width:260px}
    .toast-card{background:#0b63a5;color:#fff;padding:12px;border-radius:8px;box-shadow:0 8px 20px rgba(11,99,165,0.18)}
    /* responsive */
    @media(max-width:900px){ .grid-3{grid-template-columns:1fr} nav{overflow:auto} header{flex-direction:column;align-items:flex-start;gap:8px} main{padding:12px} }
    /* product image */
    .prod-thumb{width:48px;height:48px;border-radius:6px;object-fit:cover;border:1px solid #eee}
    /* pagination */
    .pager button{border-radius:6px}
    .autosave{font-size:12px;color:#fff;opacity:.9}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="brand">GUIMETRA <small>CONSTRUCTION</small></div>
      <div class="small-muted" style="color:rgba(255,255,255,0.9)">ERP léger — Offline first</div>
    </div>
    <div class="text-end">
      <div class="autosave" id="autosaveStatus">Sauvegarde auto : —</div>
    </div>
  </header>

  <nav>
    <button class="nav-btn active" data-target="dashboard">Tableau de bord</button>
    <button class="nav-btn" data-target="produits">Produits</button>
    <button class="nav-btn" data-target="clients">Clients</button>
    <button class="nav-btn" data-target="devis">Devis</button>
    <button class="nav-btn" data-target="m2">Calcul M²</button>
    <button class="nav-btn" data-target="convertisseur">Convertisseur</button>
    <button class="nav-btn" data-target="exports">Sauvegarde</button>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button class="btn btn-sm btn-outline-light" id="undoBtn" onclick="undoAction()" title="Annuler dernière action"><i class="fa fa-undo"></i></button>
      <button class="btn btn-sm btn-light" onclick="openHelp()">Aide</button>
    </div>
  </nav>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="card-ghost fade-in">
      <div class="grid-3 mb-3">
        <div class="metric">
          <div>
            <div class="muted">Produits</div>
            <h3 id="stat_prod">0</h3>
          </div>
          <div><i class="fa fa-box fa-2x" style="color:var(--primary)"></i></div>
        </div>

        <div class="metric">
          <div>
            <div class="muted">Clients</div>
            <h3 id="stat_clients">0</h3>
          </div>
          <div><i class="fa fa-users fa-2x" style="color:#2d6a4f"></i></div>
        </div>

        <div class="metric">
          <div>
            <div class="muted">Total devis (GNF)</div>
            <h3 id="stat_devis">0</h3>
          </div>
          <div><i class="fa fa-file-invoice-dollar fa-2x" style="color:var(--accent)"></i></div>
        </div>
      </div>

      <div class="d-flex gap-3" style="flex-wrap:wrap">
        <div style="flex:1" class="card-ghost p-3">
          <h5>CA par mois</h5>
          <canvas id="chartCA" height="140"></canvas>
        </div>
        <div style="width:360px" class="card-ghost p-3">
          <h5>Top produits</h5>
          <canvas id="chartTop" height="140"></canvas>
          <div class="mt-2 small-muted">Top produits vendus (par lignes de devis)</div>
        </div>
      </div>

      <div class="card-ghost p-3 mt-3">
        <h6>Derniers événements</h6>
        <div id="recentLogs" style="max-height:160px;overflow:auto" class="small-muted"></div>
      </div>
    </section>

    <!-- PRODUITS -->
    <section id="produits" class="card-ghost mt-3" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Produits</h5>
        <div class="d-flex gap-2 align-items-center">
          <input id="searchProd" class="form-control form-control-sm" placeholder="Rechercher produit..." oninput="renderProducts()" style="min-width:220px">
          <select id="filterType" class="form-select form-select-sm" onchange="renderProducts()" style="width:160px">
            <option value="">Tous types</option>
          </select>
          <select id="sortProd" class="form-select form-select-sm" onchange="renderProducts()" style="width:140px">
            <option value="nom">Trier: Nom</option>
            <option value="prix">Trier: Prix</option>
            <option value="qte">Trier: Qte</option>
          </select>
          <button class="btn btn-primary" onclick="openProductModal()">+ Ajouter produit</button>
        </div>
      </div>

      <div style="overflow:auto">
        <table class="data">
          <thead><tr><th></th><th>Nom</th><th>Type</th><th>Dimensions</th><th>Prix (GNF)</th><th>Qte</th><th></th></tr></thead>
          <tbody id="tblProducts"></tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-2">
        <div class="small-muted" id="prodPageInfo"></div>
        <div class="pager">
          <button class="btn btn-sm btn-outline-secondary" onclick="prevPage()">Préc</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="nextPage()">Suiv</button>
        </div>
      </div>
    </section>

    <!-- CLIENTS -->
    <section id="clients" class="card-ghost mt-3" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Clients</h5>
        <button class="btn btn-primary" onclick="openClientModal()">+ Ajouter client</button>
      </div>
      <div style="overflow:auto">
        <table class="data"><thead><tr><th>Nom</th><th>Téléphone</th><th>Adresse</th><th></th></tr></thead><tbody id="tblClients"></tbody></table>
      </div>
    </section>

    <!-- DEVIS -->
    <section id="devis" class="card-ghost mt-3" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Devis & Factures</h5>
        <div>
          <button class="btn btn-outline-secondary me-2" onclick="exportQuotesCSV()">Exporter devis (CSV)</button>
          <button class="btn btn-primary" onclick="addQuoteLine()">+ Ligne</button>
          <button class="btn btn-success" onclick="saveQuote()">Enregistrer Devis</button>
        </div>
      </div>

      <div class="mb-2 row g-2">
        <div class="col-md-6"><label class="small-muted">Client</label><select id="quote_client" class="form-select"></select></div>
        <div class="col-md-6"><label class="small-muted">Référence devis (optionnel)</label><input id="quote_ref" class="form-control"></div>
      </div>

      <div id="quote_lines"></div>

      <div class="card-ghost mt-3 p-3">
        <h6>Aperçu</h6>
        <div id="quote_preview_content" class="small-muted"></div>
        <div class="mt-2 d-flex justify-content-between align-items-center">
          <div>Total : <b id="quote_total">0</b> GNF</div>
          <div><button class="btn btn-outline-secondary" onclick="previewPDF()">Aperçu / Imprimer</button></div>
        </div>
      </div>
    </section>

    <!-- M2 -->
    <section id="m2" class="card-ghost mt-3" style="display:none">
      <h5>Calcul M² → Nombre de feuilles</h5>
      <div class="row g-2 mt-2">
        <div class="col-md-6"><input id="m2_val" class="form-control" placeholder="Surface à couvrir (m²)"></div>
        <div class="col-md-6"><input id="sheet_area" class="form-control" placeholder="Surface par feuille (m²)"></div>
      </div>
      <div class="mt-2"><button class="btn btn-accent" onclick="calcSheets()">Calculer</button></div>
      <p id="m2_result" class="small-muted mt-2"></p>
    </section>

    <!-- Convertisseur -->
    <section id="convertisseur" class="card-ghost mt-3" style="display:none">
      <h5>Convertisseur de devises</h5>
      <div class="row g-2 align-items-end">
        <div class="col-md-4"><input id="conv_amount" class="form-control" placeholder="Montant"></div>
        <div class="col-md-3"><select id="conv_from" class="form-select"><option>GNF</option><option>USD</option><option>EUR</option><option>XOF</option></select></div>
        <div class="col-md-3"><select id="conv_to" class="form-select"><option>USD</option><option>EUR</option><option>XOF</option><option>GNF</option></select></div>
        <div class="col-md-2"><button class="btn btn-primary w-100" onclick="convertCurrency()">Convertir</button></div>
      </div>

      <div class="row mt-3">
        <div class="col-md-6"><div class="card-ghost p-3"><div class="small-muted">Résultat</div><div id="conv_result" class="fs-5 mt-2">—</div></div></div>
        <div class="col-md-6"><label class="small-muted">Taux manuel</label><input id="manual_rate" class="form-control" placeholder="Ex: 0.000051 pour USD"></div>
      </div>
    </section>

    <!-- EXPORT / IMPORT -->
    <section id="exports" class="card-ghost mt-3" style="display:none">
      <h5>Sauvegarde & export</h5>
      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-outline-secondary" onclick="exportAllJSON()">Exporter (JSON)</button>
        <button class="btn btn-outline-secondary" onclick="importJSONPrompt()">Importer (JSON)</button>
        <button class="btn btn-outline-secondary" onclick="exportAllCSV()">Exporter CSV (produits)</button>
        <button class="btn btn-outline-danger" onclick="clearAllData()">Vider toutes les données</button>
      </div>
      <p class="small-muted mt-3">Autosave toutes les <b id="autosaveIntervalText"></b>. Backup disponible pour téléchargement.</p>
    </section>
  </main>

  <!-- Product Modal -->
  <div class="modal fade" id="modalProduct" tabindex="-1"><div class="modal-dialog modal-md modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Produit</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <input id="m_p_id" type="hidden">
      <label class="small-muted">Image</label>
      <div class="d-flex gap-2 mb-2 align-items-center">
        <img id="m_p_img_preview" src="" class="prod-thumb" style="display:none">
        <input id="m_p_img" type="file" accept="image/*" class="form-control form-control-sm" onchange="handleImgUpload(event)">
      </div>
      <label class="small-muted">Nom</label><input id="m_p_nom" class="form-control mb-2">
      <label class="small-muted">Code</label><input id="m_p_code" class="form-control mb-2">
      <label class="small-muted">Type</label><input id="m_p_type" class="form-control mb-2">
      <label class="small-muted">Dimensions</label><input id="m_p_dim" class="form-control mb-2">
      <label class="small-muted">Prix vente (GNF)</label><input id="m_p_prix" class="form-control mb-2" type="number">
      <label class="small-muted">Quantité</label><input id="m_p_qte" class="form-control mb-2" type="number">
    </div>
    <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" onclick="saveProductModal()">Enregistrer</button></div>
  </div></div></div>

  <!-- Client Modal -->
  <div class="modal fade" id="modalClient" tabindex="-1"><div class="modal-dialog modal-md modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Client</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <label class="small-muted">Nom</label><input id="m_c_nom" class="form-control mb-2">
      <label class="small-muted">Téléphone</label><input id="m_c_tel" class="form-control mb-2">
      <label class="small-muted">Adresse</label><input id="m_c_addr" class="form-control mb-2">
    </div>
    <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" onclick="saveClientModal()">Enregistrer</button></div>
  </div></div></div>

  <!-- Toast -->
  <div id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /************************************************************************
   *  Advanced local ERP (improved)
   *
   *  Features:
   *   - localStorage persistence
   *   - autosave with indicator
   *   - search / filter / sort / pagination
   *   - product images (base64)
   *   - undo stack
   *   - top-products & CA charts
   *   - PDF export (A4), CSV export
   *   - notifications (toast)
   ************************************************************************/

  // STORAGE KEYS
  const LS_KEYS = { products: 'gm_products', clients: 'gm_clients', quotes: 'gm_quotes', conversions: 'gm_conversions', logs: 'gm_logs' };

  // app state
  let products = loadLS(LS_KEYS.products), clients = loadLS(LS_KEYS.clients), quotes = loadLS(LS_KEYS.quotes), conversions = loadLS(LS_KEYS.conversions), logs = loadLS(LS_KEYS.logs);
  let undoStack = []; // store previous states for undo
  const PAGE_SIZE = 10;
  let prodPage = 1;

  // autosave
  const AUTOSAVE_INTERVAL_MS = 60000; // 60s
  document.getElementById('autosaveIntervalText').innerText = (AUTOSAVE_INTERVAL_MS/1000) + 's';

  function saveLS(key, val) { localStorage.setItem(key, JSON.stringify(val)); updateAutosaveStatus(); }
  function loadLS(key) { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ return []; } }

  // push undo snapshot
  function pushUndo(label){
    const snapshot = { time: Date.now(), label, products: JSON.parse(JSON.stringify(products)), clients: JSON.parse(JSON.stringify(clients)), quotes: JSON.parse(JSON.stringify(quotes)), conversions: JSON.parse(JSON.stringify(conversions)), logs: JSON.parse(JSON.stringify(logs)) };
    undoStack.push(snapshot);
    if(undoStack.length>20) undoStack.shift();
    updateUndoUI();
  }
  function updateUndoUI(){ document.getElementById('undoBtn').disabled = undoStack.length===0; }

  function undoAction(){
    if(undoStack.length===0) { toast('Aucune action à annuler','info'); return; }
    if(!confirm('Annuler la dernière action ?')) return;
    const snap = undoStack.pop();
    products = snap.products; clients = snap.clients; quotes = snap.quotes; conversions = snap.conversions; logs = snap.logs;
    saveLS(LS_KEYS.products, products); saveLS(LS_KEYS.clients, clients); saveLS(LS_KEYS.quotes, quotes); saveLS(LS_KEYS.conversions, conversions); saveLS(LS_KEYS.logs, logs);
    renderAll();
    toast('Action annulée: ' + (snap.label||'undo'), 'success');
  }

  // toast notifications
  function toast(msg, type='info', timeout=3000){
    const container = document.getElementById('toast');
    const card = document.createElement('div'); card.className='toast-card mb-2 fade-in';
    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div>${msg}</div><div style="margin-left:12px">${type==='success'?'<i class="fa fa-check-circle"></i>':type==='error'?'<i class="fa fa-exclamation-circle"></i>':'<i class="fa fa-info-circle"></i>'}</div></div>`;
    container.appendChild(card);
    setTimeout(()=>{ card.style.opacity='0'; setTimeout(()=>card.remove(),400); }, timeout);
  }

  // autosave indicator
  function updateAutosaveStatus(text){
    const el = document.getElementById('autosaveStatus');
    if(text){ el.innerText = text; return; }
    el.innerText = 'Sauvegarde auto : ' + new Date().toLocaleTimeString();
  }
  function doAutosave(){
    // save all state
    saveLS(LS_KEYS.products, products); saveLS(LS_KEYS.clients, clients); saveLS(LS_KEYS.quotes, quotes); saveLS(LS_KEYS.conversions, conversions); saveLS(LS_KEYS.logs, logs);
    updateAutosaveStatus();
    toast('Données enregistrées automatiquement', 'success', 1200);
  }
  setInterval(doAutosave, AUTOSAVE_INTERVAL_MS);

  /***********************
   * Charts
   ***********************/
  let caChart=null, topChart=null;
  function renderCharts(){
    // CA per month
    const months = Array.from({length:12}, (_,i)=>new Date(new Date().getFullYear(),i,1).toLocaleString('fr-FR',{month:'short'}));
    const totals = new Array(12).fill(0);
    quotes.forEach(q=>{ const d = new Date(q.createdAt||q.ts||Date.now()); totals[d.getMonth()] += Number(q.total||0); });
    const ctx = document.getElementById('chartCA').getContext('2d');
    if(caChart) caChart.destroy();
    caChart = new Chart(ctx, { type:'bar', data:{ labels:months, datasets:[{ label:'GNF', data:totals, backgroundColor:'rgba(11,99,165,0.9)'}] }, options:{plugins:{legend:{display:false}}, responsive:true} });

    // top products: count occurrences in quotes lines
    const counts = {};
    quotes.forEach(q=>{ (q.lines||[]).forEach(l=>{ if(l.productId) counts[l.productId] = (counts[l.productId]||0) + Number(l.qty||1); }); });
    const items = Object.keys(counts).map(id=>({id, qty:counts[id], name:(products.find(p=>p.id===id)||{}).nom||'Produit'})).sort((a,b)=>b.qty-a.qty).slice(0,6);
    const topLabels = items.map(i=>i.name); const topData = items.map(i=>i.qty);
    const ctx2 = document.getElementById('chartTop').getContext('2d');
    if(topChart) topChart.destroy();
    topChart = new Chart(ctx2, { type:'doughnut', data:{ labels:topLabels, datasets:[{data:topData, backgroundColor:['#0b63a5','#e63946','#2d6a4f','#ffa94d','#6c5ce7','#00b894']}] }, options:{plugins:{legend:{position:'right'}} } );
  }

  /***********************
   * Logs
   ***********************/
  function pushLog(action, details = {}){
    const entry = { ts: new Date().toISOString(), action, details };
    logs.unshift(entry);
    if(logs.length>500) logs.pop();
    saveLS(LS_KEYS.logs, logs);
    renderLogs();
  }
  function renderLogs(){
    document.getElementById('recentLogs').innerHTML = logs.slice(0,50).map(l=>`<div style="padding:6px 0;border-bottom:1px dashed #f1f5f9"><b>${l.action}</b><div class="small-muted">${new Date(l.ts).toLocaleString()}</div><div class="small-muted">${JSON.stringify(l.details||{})}</div></div>`).join('');
  }

  /***********************
   * Products: search/sort/pagination, image upload
   ***********************/
  function generateId(prefix){ return prefix + '_' + Date.now() + '_' + Math.floor(Math.random()*9999); }

  // image upload -> base64
  function handleImgUpload(e){
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      document.getElementById('m_p_img_preview').src = reader.result;
      document.getElementById('m_p_img_preview').style.display = 'block';
      document.getElementById('m_p_img_preview').dataset.base64 = reader.result;
    };
    reader.readAsDataURL(f);
  }

  function renderProducts(){
    const tbody = document.getElementById('tblProducts'); tbody.innerHTML = '';
    const q = (document.getElementById('searchProd').value||'').toLowerCase();
    const filterType = document.getElementById('filterType').value;
    const sortBy = document.getElementById('sortProd').value;
    let list = products.filter(p=> (!q || (p.nom||'').toLowerCase().includes(q) || (p.code||'').toLowerCase().includes(q)) && (!filterType || (p.type||'')===filterType ));
    if(sortBy==='nom') list.sort((a,b)=> (a.nom||'').localeCompare(b.nom||''));
    if(sortBy==='prix') list.sort((a,b)=> (Number(b.prixVente||0) - Number(a.prixVente||0)));
    if(sortBy==='qte') list.sort((a,b)=> (Number(b.quantite||0) - Number(a.quantite||0)));
    // pagination
    const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
    prodPage = Math.min(prodPage, totalPages);
    const start = (prodPage-1)*PAGE_SIZE; const pageItems = list.slice(start, start+PAGE_SIZE);
    pageItems.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><img src="${p.image||''}" class="prod-thumb" style="${p.image?'display:block':'display:none'}"><div style="display:inline-block;margin-left:8px;vertical-align:top"><b>${escapeHtml(p.nom)}</b><div class="small-muted">${escapeHtml(p.code||'')}</div></div></td>
                      <td>${escapeHtml(p.type||'')}</td>
                      <td>${escapeHtml(p.dimensions||'')}</td>
                      <td>${(Number(p.prixVente)||0).toLocaleString()}</td>
                      <td>${Number(p.quantite)||0}</td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick='openProductModal(${JSON.stringify(p).replace(/'/g,"\\'")})'><i class="fa fa-pen"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${p.id}')"><i class="fa fa-trash"></i></button>
                      </td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('prodPageInfo').innerText = `Page ${prodPage} / ${totalPages} — ${list.length} résultats`;
    renderFilterTypes(); updateStats();
  }

  function renderFilterTypes(){
    const sel = document.getElementById('filterType'); const types = Array.from(new Set(products.map(p=>p.type).filter(Boolean)));
    sel.innerHTML = '<option value="">Tous types</option>' + types.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
  }

  function prevPage(){ if(prodPage>1) { prodPage--; renderProducts(); } }
  function nextPage(){ prodPage++; renderProducts(); }

  function openProductModal(prod=null){
    if(prod){
      document.getElementById('m_p_id').value = prod.id;
      document.getElementById('m_p_nom').value = prod.nom || '';
      document.getElementById('m_p_code').value = prod.code || '';
      document.getElementById('m_p_type').value = prod.type || '';
      document.getElementById('m_p_dim').value = prod.dimensions || '';
      document.getElementById('m_p_prix').value = prod.prixVente || 0;
      document.getElementById('m_p_qte').value = prod.quantite || 0;
      if(prod.image){ document.getElementById('m_p_img_preview').src = prod.image; document.getElementById('m_p_img_preview').style.display = 'block'; document.getElementById('m_p_img_preview').dataset.base64 = prod.image; } else { document.getElementById('m_p_img_preview').style.display='none'; document.getElementById('m_p_img_preview').src=''; document.getElementById('m_p_img_preview').dataset.base64=''; }
    } else {
      ['m_p_id','m_p_nom','m_p_code','m_p_type','m_p_dim','m_p_prix','m_p_qte'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('m_p_img_preview').style.display='none'; document.getElementById('m_p_img_preview').src=''; document.getElementById('m_p_img_preview').dataset.base64='';
      document.getElementById('m_p_img').value = '';
    }
    new bootstrap.Modal(document.getElementById('modalProduct')).show();
  }

  function saveProductModal(){
    const id = document.getElementById('m_p_id').value || null;
    const payload = {
      id: id || generateId('p'),
      nom: document.getElementById('m_p_nom').value.trim(),
      code: document.getElementById('m_p_code').value.trim(),
      type: document.getElementById('m_p_type').value.trim(),
      dimensions: document.getElementById('m_p_dim').value.trim(),
      prixVente: Number(document.getElementById('m_p_prix').value||0),
      quantite: Number(document.getElementById('m_p_qte').value||0),
      image: document.getElementById('m_p_img_preview').dataset.base64 || ''
    };
    if(!payload.nom){ toast('Nom requis','error'); return; }
    pushUndo('product_save');
    if(id){
      products = products.map(p=>p.id===id?payload:p);
      pushLog('update_product', payload);
      toast('Produit mis à jour','success');
    } else {
      products.unshift(payload);
      pushLog('create_product', payload);
      toast('Produit ajouté','success');
    }
    saveLS(LS_KEYS.products, products);
    renderProducts();
    bootstrap.Modal.getInstance(document.getElementById('modalProduct')).hide();
  }

  function deleteProduct(id){
    if(!confirm('Supprimer ce produit ?')) return;
    pushUndo('product_delete');
    products = products.filter(p=>p.id!==id);
    saveLS(LS_KEYS.products, products);
    renderProducts(); pushLog('delete_product',{id}); toast('Produit supprimé','success');
  }

  /***********************
   * Clients
   ***********************/
  function renderClients(){
    const tbody = document.getElementById('tblClients');
    const sel = document.getElementById('quote_client');
    tbody.innerHTML = ''; sel.innerHTML = '<option value="">-- Aucun --</option>';
    clients.forEach(c=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(c.nom)}</td><td>${escapeHtml(c.tel||'')}</td><td>${escapeHtml(c.addr||'')}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="deleteClient('${c.id}')"><i class="fa fa-trash"></i></button></td>`;
      tbody.appendChild(tr);
      const opt = document.createElement('option'); opt.value=c.id; opt.textContent=c.nom + (c.tel? ' • '+c.tel : '');
      sel.appendChild(opt);
    });
    updateStats();
  }

  function openClientModal(c=null){
    if(c){ document.getElementById('m_c_nom').value = c.nom||''; document.getElementById('m_c_tel').value = c.tel||''; document.getElementById('m_c_addr').value = c.addr||''; }
    else { ['m_c_nom','m_c_tel','m_c_addr'].forEach(id=>document.getElementById(id).value=''); }
    new bootstrap.Modal(document.getElementById('modalClient')).show();
  }

  function saveClientModal(){
    const doc = { id: generateId('c'), nom: document.getElementById('m_c_nom').value.trim(), tel: document.getElementById('m_c_tel').value.trim(), addr: document.getElementById('m_c_addr').value.trim() };
    if(!doc.nom){ toast('Nom requis','error'); return; }
    pushUndo('client_create');
    clients.unshift(doc); saveLS(LS_KEYS.clients, clients); renderClients(); pushLog('create_client', doc); toast('Client ajouté','success');
    bootstrap.Modal.getInstance(document.getElementById('modalClient')).hide();
  }

  function deleteClient(id){
    if(!confirm('Supprimer client ?')) return;
    pushUndo('client_delete');
    clients = clients.filter(c=>c.id!==id); saveLS(LS_KEYS.clients, clients); renderClients(); pushLog('delete_client',{id}); toast('Client supprimé','success');
  }

  /***********************
   * Devis
   ***********************/
  let quoteLines = [];
  function addQuoteLine(){ quoteLines.push({ productId:'', qty:1, price:0 }); renderQuoteLines(); }
  function removeQuoteLine(i){ quoteLines.splice(i,1); renderQuoteLines(); }

  function renderQuoteLines(){
    const container = document.getElementById('quote_lines'); container.innerHTML = '';
    quoteLines.forEach((l,i)=>{
      const options = products.map(p=>`<option value="${p.id}" ${p.id===l.productId?'selected':''}>${escapeHtml(p.nom)}</option>`).join('');
      const div = document.createElement('div'); div.className='d-flex gap-2 mb-2 align-items-center';
      div.innerHTML = `<select class="form-select" id="ql_prod_${i}" style="flex:2"><option value="">-- produit --</option>${options}</select>
                        <input class="form-control" id="ql_qty_${i}" style="max-width:110px" type="number" value="${l.qty}">
                        <input class="form-control" id="ql_price_${i}" style="max-width:150px" value="${l.price}">
                        <button class="btn btn-outline-danger" onclick="removeQuoteLine(${i})"><i class="fa fa-trash"></i></button>`;
      container.appendChild(div);
      document.getElementById(`ql_prod_${i}`).onchange = (e)=>{ const pid=e.target.value; const p=products.find(x=>x.id===pid); quoteLines[i].productId = pid; quoteLines[i].price = p ? (p.prixVente||0) : 0; renderQuoteLines(); };
      document.getElementById(`ql_qty_${i}`).oninput = (e)=>{ quoteLines[i].qty = Number(e.target.value||0); renderQuotePreview(); };
      document.getElementById(`ql_price_${i}`).oninput = (e)=>{ quoteLines[i].price = Number(e.target.value||0); renderQuotePreview(); };
    });
    renderQuotePreview();
  }

  function renderQuotePreview(){
    const preview = document.getElementById('quote_preview_content'); let html=''; let total=0;
    quoteLines.forEach(l=>{
      const p = products.find(x=>x.id===l.productId) || {};
      const name = p.nom || '—';
      const img = p.image ? `<img src="${p.image}" class="prod-thumb me-2" style="width:36px;height:36px">` : '';
      const lineTotal = (Number(l.price)||0)*(Number(l.qty)||0);
      total += lineTotal;
      html += `<div class="d-flex justify-content-between align-items-center"><div style="display:flex;align-items:center">${img}<div><b>${escapeHtml(name)}</b><div class="small-muted">${escapeHtml(p.code||'')}</div></div></div><div>${(Number(l.qty)||0)} × ${(Number(l.price)||0).toLocaleString()} = ${lineTotal.toLocaleString()} GNF</div></div><hr>`;
    });
    preview.innerHTML = html || '<div class="small-muted">Aucune ligne</div>';
    document.getElementById('quote_total').innerText = total.toLocaleString();
  }

  function saveQuote(){
    const clientId = document.getElementById('quote_client').value || null;
    const ref = document.getElementById('quote_ref').value || '';
    const total = Number((document.getElementById('quote_total').innerText||'0').replace(/,/g,'')) || 0;
    if((quoteLines||[]).length===0){ toast('Ajoute au moins une ligne','error'); return; }
    pushUndo('create_quote');
    const data = { id: generateId('q'), clientId, ref, lines: JSON.parse(JSON.stringify(quoteLines)), total, createdAt: new Date().toISOString() };
    quotes.unshift(data); saveLS(LS_KEYS.quotes, quotes); pushLog('create_quote', data); toast('Devis enregistré','success');
    // reset
    quoteLines = []; addQuoteLine(); renderQuotes(); renderCharts();
  }

  function renderQuotes(){ updateStats(); }

  function previewPDF(){
    const clientId=document.getElementById('quote_client').value; const client=clients.find(c=>c.id===clientId);
    const title = `Devis - ${client?client.nom:''} - ${new Date().toLocaleString()}`;
    const el=document.createElement('div'); el.style.padding='20px'; el.style.fontFamily='Arial';
    el.innerHTML = `<h2>${escapeHtml(title)}</h2><div><b>Client:</b> ${escapeHtml(client?client.nom:'—')}</div><div style="margin-top:12px">${document.getElementById('quote_preview_content').innerHTML}</div><h3 style="margin-top:12px">Total : ${document.getElementById('quote_total').innerText} GNF</h3><p class="small-muted">GUIMETRA Construction</p>`;
    html2pdf().from(el).set({margin:15, filename:`devis-${Date.now()}.pdf`, jsPDF:{format:'a4'}}).save();
  }

  function exportQuotesCSV(){
    if(quotes.length===0){ toast('Aucun devis à exporter','info'); return; }
    const rows=[['id','client','ref','total','date']];
    quotes.forEach(q=>{ const clientName = (clients.find(c=>c.id===q.clientId)||{}).nom||''; rows.push([q.id, clientName, q.ref||'', q.total, q.createdAt||'']); });
    const csv = rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='devis.csv'; a.click(); URL.revokeObjectURL(url); toast('CSV devis téléchargé','success');
  }

  /***********************
   * Convertisseur + M2
   ***********************/
  async function convertCurrency(){
    const amount = Number(document.getElementById('conv_amount').value || 0); const from = document.getElementById('conv_from').value; const to = document.getElementById('conv_to').value;
    if(!amount){ toast('Saisis un montant','error'); return; }
    try{
      const r = await fetch(`https://api.exchangerate.host/convert?from=${from}&to=${to}&amount=${amount}`);
      const d = await r.json();
      if(d && d.result!=null){
        document.getElementById('conv_result').innerText = `${Number(d.result).toLocaleString()} ${to}`;
        const entry = { montant: amount, from, to, resultat: d.result, mode:'api', ts:new Date().toISOString() };
        conversions.unshift(entry); saveLS(LS_KEYS.conversions, conversions); pushLog('conversion', entry);
        toast('Conversion OK','success');
        return;
      }
      throw new Error('no result');
    }catch(e){
      const manual = Number(document.getElementById('manual_rate').value || 0);
      if(manual){
        const res = amount * manual;
        document.getElementById('conv_result').innerText = `${res.toLocaleString()} ${to} (manuel)`;
        const entry = { montant: amount, from, to, resultat: res, mode:'manuel', ts:new Date().toISOString() };
        conversions.unshift(entry); saveLS(LS_KEYS.conversions, conversions); pushLog('conversion', entry); toast('Conversion manuelle enregistrée','success');
        return;
      }
      document.getElementById('conv_result').innerText = 'Conversion impossible (API ou taux manuel requis)'; toast('Conversion impossible','error');
    }
  }

  function calcSheets(){
    const s = Number(document.getElementById('m2_val').value || 0);
    const per = Number(document.getElementById('sheet_area').value || 0);
    if(!s || !per){ document.getElementById('m2_result').innerText = 'Remplis les deux valeurs'; return; }
    const nb = Math.ceil(s / per);
    document.getElementById('m2_result').innerText = `Il faut ${nb} feuilles (arrondi supérieur).`;
    pushLog('calc_m2', { surface:s, per, result:nb });
    toast('Calcul M² effectué','success');
  }

  /***********************
   * Export / Import / Clear
   ***********************/
  function exportAllJSON(){
    const data = { products, clients, quotes, conversions, logs };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `guimetra-backup-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url); pushLog('export_json',{}); toast('Export JSON prêt','success');
  }

  function importJSONPrompt(){
    const input = document.createElement('input'); input.type='file'; input.accept='application/json';
    input.onchange = (e)=> {
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=> {
        try{
          const obj = JSON.parse(reader.result);
          pushUndo('import_json');
          if(obj.products) products = obj.products;
          if(obj.clients) clients = obj.clients;
          if(obj.quotes) quotes = obj.quotes;
          if(obj.conversions) conversions = obj.conversions;
          if(obj.logs) logs = obj.logs;
          saveLS(LS_KEYS.products, products); saveLS(LS_KEYS.clients, clients); saveLS(LS_KEYS.quotes, quotes); saveLS(LS_KEYS.conversions, conversions); saveLS(LS_KEYS.logs, logs);
          renderAll(); toast('Import OK','success'); pushLog('import_json',{}); 
        }catch(err){ toast('Fichier JSON invalide','error'); }
      };
      reader.readAsText(f);
    };
    input.click();
  }

  function exportAllCSV(){
    if(products.length===0){ toast('Aucun produit','info'); return; }
    const rows = [['nom','code','type','dimensions','prixVente','quantite'], ...products.map(p=>[p.nom,p.code,p.type,p.dimensions,p.prixVente,p.quantite])];
    const csv = rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='produits.csv'; a.click(); URL.revokeObjectURL(url); pushLog('export_csv',{}); toast('CSV téléchargé','success');
  }

  function clearAllData(){ if(!confirm('Vider toutes les données locales ?')) return; pushUndo('clear_all'); products=[]; clients=[]; quotes=[]; conversions=[]; logs=[]; saveLS(LS_KEYS.products, products); saveLS(LS_KEYS.clients, clients); saveLS(LS_KEYS.quotes, quotes); saveLS(LS_KEYS.conversions, conversions); saveLS(LS_KEYS.logs, logs); renderAll(); toast('Toutes les données ont été vidées','success'); }

  /***********************
   * Util
   ***********************/
  function escapeHtml(text=''){ return String(text||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // update stats
  function updateStats(){
    document.getElementById('stat_prod').innerText = products.length;
    document.getElementById('stat_clients').innerText = clients.length;
    const totalDevis = quotes.reduce((s,q)=>s + (Number(q.total)||0), 0);
    document.getElementById('stat_devis').innerText = totalDevis.toLocaleString();
    renderCharts();
  }

  function renderAll(){
    renderProducts(); renderClients(); renderQuotes(); renderCharts(); renderLogs(); updateStats(); updateUndoUI();
  }

  /***********************
   * Navigation bind
   ***********************/
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      const tgt = btn.dataset.target; document.querySelectorAll('main section').forEach(s=>s.style.display='none'); document.getElementById(tgt).style.display='block';
      if(tgt==='produits') renderProducts();
      if(tgt==='clients') renderClients();
      if(tgt==='devis'){ renderQuoteLines(); renderClients(); renderProducts(); }
      if(tgt==='dashboard') renderAll();
    });
  });

  function openHelp(){
    const txt = `Aide rapide :
- Ajouter produit : Products → + Ajouter produit (tu peux ajouter une photo).
- Créer devis : Devis → choisir client → ajouter lignes → Enregistrer.
- Undo : annule la dernière action (création/modif/suppression/import/clear).
- Sauvegarde : Export JSON pour transférer / sauvegarder.
Remarque : données stockées dans ton navigateur (localStorage).`;
    alert(txt);
  }

  /***********************
   * Init
   ***********************/
  function init(){
    products = loadLS(LS_KEYS.products); clients = loadLS(LS_KEYS.clients); quotes = loadLS(LS_KEYS.quotes); conversions = loadLS(LS_KEYS.conversions); logs = loadLS(LS_KEYS.logs);
    renderAll();
    document.querySelector('.nav-btn[data-target="dashboard"]').click();
    quoteLines = []; addQuoteLine();
    updateAutosaveStatus('Dernière sauvegarde : ' + (localStorage.getItem('_gm_last_save') || 'Jamais'));
    // initial autosave marker
    setInterval(()=>{ localStorage.setItem('_gm_last_save', new Date().toISOString()); updateAutosaveStatus(); }, AUTOSAVE_INTERVAL_MS);
  }

  window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
